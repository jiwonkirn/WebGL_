# 웹지엘 파이프라인

1. 버텍스 셰이더
2. 프리미티브 어셈블리
3. 레스터화
4. 프래그먼트 세이더
5. 가위 테스트
6. 멀티샘플 프래그먼트 연산
7. 스텐실 테스트
8. 깊이 버퍼 테스트
9. 블렌딩
10. 디더링
11. 그리기 버퍼

5번 ~ 10번은 프래그먼트당 연산이다.

#### 셰이딩

광원이 오브젝트를 비출 때 오브젝트의 노출 방법도 고려해야 한다. 다양한 재질에 빛이 반사될 때 나타나는 광원 효과를 결정짓는 처리를 셰이딩이라고 한다.

웹지엘의 셰이딩은 **버텍스 셰어더**, **프레그먼트 셰이더** 두 단계로 진행된다.

<br>

### 버텍스 셰이더

버텍스 셰이더는 파이프라인에서 버텍스에 셰이딩 효과를 입히는 단계이다.

실질적인 셰이딩을 적용하기 전에 버텍스 셰이더는 각 버텍스를 변환 행렬과 곱한다. 오브젝트의 모든 버텍스에 변환 행렬을 곱하면 오브젝트는 장면의 특정 위치에 자리잡게 된다.

버텍스 셰이더는 다음과 같은 입력값을 사용한다.

- 버텍스 셰이더를 구성하는 소스 코드 (오픈지엘 ES 셰이딩 언어, GLSL ES)
- 각 버텍스에 적용되는 유저가 정의한 어트리뷰트 변수 (버텍스의 위치와 색상 등)
- 유니폼 상수 (변환 행렬과 광원의 위치 등)
  - 그리기 명령 사이에 유니폼 값 변환이 가능하므로 그리기 명령 진행 중일 때만 상수 값을 유지한다.

#### 예시

```glsl
// 어트리뷰트 (위치 색상)
attribute vec3 aVertexPos;
attribute vec4 aVertexColor;

// 유니폼 (변환 행렬, 광원의 위치 등)
// 모든 버텍스에 일괄 적용된다.
uniform mat4 nMVMatrix;
uniform mat4 uPMatrix;

// 버텍스 셰이더가 프래그먼트 셰이더로 정보를 전송할 때 이용됨
varying vec4 vColor;

void main() {
  // 각 버텍스의 위치 저장
  gl_Position = uPMatirx * uMVMatrix * vec4 (aVertexPos, 1.0);

  // 베텍스 셰이더의 결과물로 출력되는 색상 정보를 저장
  vColor = aVertexColor;
}
```

### 프리미티브 어셈블리

개별적으로 셰이딩된 버텍스를 조립해 삼각형이나, 선, 포인트 스프라이트 등의 기하 프리미티브를 생성한다. 그리고 해당 프리미티브가 모니터상에 표시될 3D 공간 안에 위치하는지를 결정해야 한다. 보통 이런 가시적인 3D 공간을 뷰절두체(view trustum) 이라고 하며 직사각형을 밑면으로 하는 피라미드 모양을 가진다.

뷰절두체 안에 있는 프리미티브는 다음 단계의 파이프라인으로 보내지고 밖에 있다면 제거된다.

### 래스터화 (단편화)

프래그먼트 셰이더에 전송할 프리미티브(선, 삼각형, 포인트 스프라이트)를 쪼개는 단계다. 프래그먼트를 화면상에 그려지는 픽셀이라고 생각할 수도 있다.

### 프래그먼트 셰이더

기본적으로 프래그먼트는 하나의 픽셀에 대응되지만 모든 프래그먼트가 그리기 버퍼의 픽셀이 디는 것은 아니다. 일부 프래그먼트는 파이프라인 마지막 단계에서 프래그먼트 연산에 제외될 수 있다.
(따라서 둘은 구분된다. 그리기 버퍼에 저장되어야 비로소 픽셀이라 부른다.)

프래그먼트 셰이더의 입력값은 다음과 같다.

- 오픈지엘 ES 셰이딩 언어로 작성된 소스 코드
- 내장된 특별 변수 (ex. gl_PointCoord)
- 버텍스 셰이더에서 넘어온 유저가 정의한 varying 변수
- 모든 프래그먼트에 적용되는 유니폼 상수 변수
- 텍스쳐링에 사용되는 유니폼 변수의 특별한 타입인 샘플러

일반적으로 프래그먼트가 버텍스보다 훨씬 많은 숫자로 구성된다, 버텍스 셰이더에서 정의된 `varying` 변수는 프래그먼트 셰이더에 선형 보간되어 전달된다. `varying` 변수가 프래그먼트 셰이더에서 읽히면 그 값은 선형 보간되어 있기 때문에 버텍스 셰이더 값과 다르다.

> 선형 보간에 대한 레퍼런스: https://bskyvision.com/789

프래그먼트 셰이더릐 출력 값은 개별 프래스먼트의 색상 값을 저장하고 있는 내장 변수인 gl_FragColor이다.

```glsl
// 정밀도 선언 변수
precision mediump float;
  // vColor는 버텍스 셰이더의 varying 변수가 선형 보간되어 프래그먼트 셰이더로 넘겨진 값을 저장하고 있다.
  varying vec4 vColor;
  void main() {
    gl_Fragment = vColor;
  }
```

### 프래그먼트당 연산

프래그먼트 셰이더를 빠져나온 각 프래그먼트는 프래그먼트 연산이 수행되는 파이프라인 단계로 진행한다. 하위 각 단계별로 기능을 활성 또는 비활성할 수 있다.

#### 가위 테스트

가위 테스트는 좌하단 좌표와 너비 높이로 설정된 가위 사각형 안에 프래그먼트가 위치하고 있는지를 결정하는 단계이다. 사각형 안에 위치하지 못한다면 해당 프래그먼트는 다음 단계로 진행하지 못하며 그리기 버퍼에 도달할 수 없다.

#### 멀티샘플 프래그먼트 연산

프래그먼트의 알파 값을 저정하고 안티 앨리어싱 적용을 위해 그 값을 변환한다.

> 안티 앨리어싱: 폴리곤의 선을 들쭉날쭉하지 않고 부드럽게 화면에 표현하도록 개선하는 기법

#### 스텐실 테스트

스텐실 버퍼상에서 입력으로 들어온 프래그먼트를 제외시킬지 여부를 테스트한다.

#### 깊이 버퍼 테스트

깊이 버처 테스트는 깇이 버퍼에 쓰여진 값에 따라 프래그먼트를 제외하는 테스트이다. (Z 버퍼라고도 부른다.)

장면에서 오브젝트는 다른 오브젝트에 의해 가려질 수 있다. 깊이 버퍼와 깊이 버퍼 테스트는 색상 버퍼에서 어떤 픽셀이 그려져야 하는지를 결정핟나. 깊이 버퍼는 개별 픽셀에 대해서 관찰자로부터 현재 가장 가까운 프리미티브와의 거리를 저장한다.

입력되는 프래그먼트가 포함하는 z-value 값이 현재 깊이 버퍼의 같은 위치에 쓰여진 값과 비교된다. z-value의 겂이 깊이 버퍼의 값보다 작을 경우 이미 색상 버퍼에 기록된 픽셀보다 더 가까운 것이고, 이런 프래그먼트는 테스트를 통과한다.

#### 블렌딩

입력되는 프래그먼트의 색상값과 생각 버퍼의 같은 위치에 이전에 쓰여진 색상값을 혼합한다. 불투명한 오브젝트를 만들 때 유용하다.

#### 디더링

색상 버퍼는 모든 컬러를 표현하기에 제한된 비트를 가지고 있다. 디더링은 실제 표현 가능한 색상보다 많은 색상 값을 가진 것처럼 보이는 착시 현상과 같은 방식으로 색상을 조정한다. (표현 가능한 색상이 적은 색상 버퍼에 유용하다.)
